const cards=["hellocon.md","submit.md"];let showdown=loadscript("https://cdnjs.cloudflare.com/ajax/libs/showdown/1.8.6/showdown.min.js","showdown").then(e=>(showdown=Promise.resolve(e),e));const converter=showdown.then(e=>new e.Converter);async function mdtohtml(e){return(await converter).makeHtml(e)}async function main(){loadcss("cards.css");const e=importhtml("cards.html"),t=await e,n=$(".mastercard",t).content.children[0];fetchCards(cards).map(mdtohtml).map(parseHtml).map(e=>plugintemplate(e,n)).forEach(e=>listenExpandcard(e)).forEach(globalHandler.addTOC).forEach(globalHandler.addcard)}main();function attachnewcard(e){const t=e.cloneNode(!0);cardeditable(t,e),listenExpandcard(t),globalHandler.addcard(t)}function fetchCards(e){return new Promises(e.map(e=>fetch("cards/"+e).then(e=>e.text())))}function plugintemplate(e,t){const n=t.cloneNode(!0),[i,a,r,...s]=e.children,o=r.firstElementChild,l=$(".thumbnail",n);$$("iframe",e).forEach(swapsrc),Object.assign($(".cardtitle",n),{textContent:i.textContent,id:i.id}),removeAllChildren(l),o.setAttribute("crossOrigin","anonymous"),l.appendChild(o),$(".brief",n).textContent=a.textContent;const c=$(".details",n);return removeAllChildren(c),s.forEach(e=>c.appendChild(e)),n}function listenExpandcard(e){const t=e.firstElementChild,n=Rx.Observable.fromEvent(e,"transitionend",{passive:!0}).debounceTime(5);return t.subscribe("click",t=>{const i=$$("iframe",e);mobile||i.forEach(swapsrc),requestAnimationFrame(()=>{e.classList.toggle("expanded"),mobile||n.first().subscribe(()=>{t.target.scrollIntoView({behavior:"smooth"})})})})}function cardeditable(e,t){const n=$(".cardtitle",e),i=$(".brief",e),a=$(".details",e),r=$(".thumbnail",e),s=$(".card-content",e);r.dataset.url=$("img",r)?$("img",r).src:"",makeeditable(n,i,a);let o=titletoid(n.textContent);s.onclick=(async()=>{if(!e.classList.contains("editing")){const i=await enterediting(e);i?(console.log(i),e.classList.contains("reviewing")?globalHandler.redirectTOC(o,e):(requestAnimationFrame(()=>{requestAnimationFrame(()=>{alert("Thank you! We will review your card, but you can preview it in place now.")})}),globalHandler.addTOC(e),attachnewcard(t)),o=n.id,requestAnimationFrame(()=>{e.classList.add("reviewing")})):cardeditable(e,t)}})}function titletoid(e){return e.toLowerCase().replace(/\s/g,"")}async function enterediting(e){const t=new Awaiter;console.log("entering editing mode",e),requestAnimationFrame(()=>e.classList.add("editing"));const n=$(".cardtitle",e),i=$(".card-content",e),a=i.cloneNode(!0),r=$("label",i),s=$('input[type="file"]',i),o=$('input[name="imglink"]',i),l=$(".done",e),c=$(".cancel",e),d=$(".thumbnail",i);let u=d.dataset.url||"";function m(e){u=e,requestAnimationFrame(()=>{d.style.backgroundImage=`url(${e})`,d.dataset.url=e,d.classList.add("dragover")})}const g=d.subscribe("dragenter",e=>{e.preventDefault(),console.log("dragenter"),requestAnimationFrame(()=>{d.classList.add("dragover")}),setTimeout(()=>{d.ondragleave=(e=>{console.log("dragleave"),e.preventDefault(),requestAnimationFrame(()=>{d.classList.remove("dragover"),d.ondragleave=null})})},100)}),b=d.subscribe("dragover",e=>e.preventDefault()),f=d.subscribe("drop",async e=>{e.preventDefault();const t=await processimginput(e.dataTransfer);t&&m(t)}),h=d.subscribe("click",e=>{requestAnimationFrame(()=>d.classList.remove("dragover"))}),p=r.subscribe("click",()=>{s.click()}),w=s.subscribe("change",async e=>{const t=e.target.files[0];isImgfile(t)&&m(await blobtoUrl(t))}),v=o.subscribe("input",async e=>{const t=e.target.value;await isImgLinkValid(t)&&m(t)});l.onclick=(e=>{e.stopPropagation(),l.onclick=null;const a={title:$("h2",i).textContent,brief:$(".brief",i).textContent,details:$(".details",i).textContent,thumbnailurl:u};n.id=titletoid(n.textContent),t.done(a)}),c.onclick=(n=>{n.stopPropagation(),c.onclick=null,e.replaceChild(a,i),t.done(!1)});const C=await t.promise;return e.classList.remove("editing"),[g,b,f,h,p,w,v].forEach(e=>e.unsubscribe()),C}async function processimginput(e){const t=e.types;if(console.log(t),t.includes("Files")){const t=e.files[0];return isImgfile(t)?await blobtoUrl(t):null}if(t.includes("text/uri-list")){const t=e.getData("text/uri-list");return await isImgLinkValid(t)?t:null}return null}function isImgfile(e){return e.type.includes("image")}function isImgLinkValid(e){return e.length>10&&fetch(e).then(e=>e.ok).catch(()=>!1)}